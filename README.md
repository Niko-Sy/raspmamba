# **古韵调新 \- MIDI 编辑器**

“古韵调新”是一个基于 PyQt5 的桌面应用程序，旨在提供一个直观的 MIDI 文件编辑和播放环境。它允许用户加载、保存 MIDI 文件，在交互式的钢琴卷帘视图中查看和修改音符，并支持 MIDI 设备的录制和播放。

## **功能特性**

### **MIDI 文件管理**

* **新建文件**: 创建一个空的 MIDI 文件。  
* **打开文件**: 加载现有的 .mid 或 .midi 文件，支持损坏文件检测。  
* **保存文件**: 保存当前编辑的 MIDI 文件。  
* **另存为**: 将当前文件保存到指定位置。  
* **关闭文件**: 关闭当前打开的 MIDI 文件，并提供保存提示。  
* **退出程序**: 安全退出应用程序，并清理临时文件。

### **MIDI 播放**

* **播放/暂停**: 控制 MIDI 文件的播放。  
* **停止**: 停止当前播放，并将播放头重置到开始。  
* **进度条**: 显示播放进度，并允许用户拖动以跳转到特定时间点。  
* **音量控制**: 调整主播放音量。  
* **音色切换**: 通过菜单选择不同的 General MIDI 乐器音色进行播放预览。

### **MIDI 录制**

* **开始/停止录制**: 连接 MIDI 输入设备并录制 MIDI 事件。  
* **设备选择**: 在菜单中列出并选择可用的 MIDI 输入端口。  
* **录制进度**: 显示当前录制时长。  
* **录制后保存**: 录制结束后自动加载录制内容并提示保存。

### **钢琴卷帘视图 (Piano Roll View)**

* **可视化**: 以钢琴卷帘的形式直观地显示 MIDI 音符。  
* **缩放**: 通过鼠标滚轮进行水平（时间）和垂直（音高）缩放。  
* **平移**: 拖拽视图以浏览不同的区域。  
* **时间指示器**: 实时显示播放头位置。

### **音符编辑**

* **选择**: 单击或拖动选择音符，支持多选。  
* **移动**: 拖动选中的音符以改变其开始时间或音高。  
* **调整长度**: 拖动音符右边缘以改变其持续时间。  
* **添加音符**: 在钢琴卷帘上点击空白区域添加新音符。  
* **删除音符**: 删除选中的音符。  
* **复制/粘贴/剪切**: 支持标准快捷键操作。  
* **量化**: 将选中的音符对齐到最近的网格（默认 16 分音符）。  
* **调整力度**: 增加或减少选中音符的力度（音量）。  
* **上下文菜单**: 右键点击音符可快速访问删除、量化、力度调整等功能。

## **后端技术**

* **PyQt5**: 用于构建图形用户界面。  
* **miditoolkit**: 用于 MIDI 文件的解析、操作和生成。  
* **pygame**: 用于音频播放（通过 pygame.mixer）。  
* **pygame.midi / rtmidi / mido**: 用于 MIDI 设备输入/输出。  
* **midi2audio (FluidSynth)**: 将 MIDI 文件转换为 WAV 音频，以实现音色切换和播放。

## **项目结构**

.  
├── main.py                     \# 应用程序主入口  
├── midirecorder.py             \# MIDI 录制模块  
├── rollview.py                 \# 钢琴卷帘视图模块  
├── soundfont/  
│   └── GeneralUser-GS.sf2      \# 默认音色库文件  
├── fluidsynth-2.4.3/  
│   └── bin/  
│       └── fluidsynth.exe      \# FluidSynth 可执行文件 (Windows)  
├── dist/  
│   └── icon.ico                \# 应用程序图标  
├── output/                     \# 录制和保存 MIDI 文件的默认输出目录  
└── temp/                       \# 临时文件存储目录

## **安装与运行**

### **环境准备**

1. **Python 3.x**: 确保您的系统安装了 Python 3。  
2. **依赖库**: 打开终端或命令提示符，运行以下命令安装所需库：  
   pip install PyQt5 miditoolkit pygame mido python-rtmidi midi2audio

3. **FluidSynth**:  
   * **Windows**: 从 [FluidSynth 官网](https://www.google.com/search?q=http://www.fluidsynth.org/download/) 下载并安装 FluidSynth。确保 fluidsynth.exe 在您的系统 PATH 中，或者将其放置在项目根目录下的 fluidsynth-2.4.3/bin/ 目录中。  
   * **macOS/Linux**: 通常可以通过包管理器安装：  
     * **macOS (Homebrew)**: brew install fluidsynth  
     * **Linux (apt)**: sudo apt-get install fluidsynth  
4. **音色库 (SoundFont)**: 确保 GeneralUser-GS.sf2 文件存在于项目根目录的 soundfont 文件夹中。

### **运行应用程序**

在项目根目录下打开终端或命令提示符，运行：

python main.py

## **使用说明**

* **文件菜单**: 使用“文件”菜单进行新建、打开、保存、另存为和关闭 MIDI 文件。  
* **播放控制**: 使用界面下方的“播放”、“暂停”、“停止”按钮控制播放。  
* **音量调节**: 使用右侧的垂直滑块调整音量。  
* **音色选择**: 在“工具”-\>“音色”菜单中选择不同的乐器音色。  
* **录制**: 点击“开始录制”按钮，通过连接的 MIDI 设备进行演奏，再次点击停止录制。录制完成后会自动加载并提示保存。  
* **钢琴卷帘操作**:  
  * **选择/移动**: 鼠标左键点击音符可选中，拖动选中的音符可移动。按住 Ctrl 键可进行多选。  
  * **调整长度**: 将鼠标悬停在音符的右边缘，光标变为水平调整箭头后拖动可改变音符长度。  
  * **添加音符**: 在“工具”菜单中选择“添加音符”模式，然后在钢琴卷帘上点击空白处添加新音符。  
  * **右键菜单**: 右键点击音符可弹出上下文菜单，进行删除、量化、力度调整等操作。  
* **键盘快捷键**: 支持 Delete/Backspace (删除), Ctrl+C (复制), Ctrl+X (剪切), Ctrl+V (粘贴), Ctrl+A (全选), Q (量化)。

## **注意事项**

* 确保 FluidSynth 已正确安装并配置。  
* MIDI 录制功能需要连接兼容的 MIDI 输入设备。  
* 在关闭应用程序前，请注意保存您的工作，程序会提示您保存未保存的修改。  
* 临时文件会在程序退出时自动清理。

## **贡献**

欢迎对本项目进行贡献！如果您有任何建议或发现 Bug，请提交 Issue 或 Pull Request。

